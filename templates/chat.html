{% extends "base.html" %}

{% block title %}WebTalk - {{ room.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Chat Header -->
            <div class="card chat-header mb-3">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1 text-white">
                            <i class="fas fa-comments me-2" aria-hidden="true"></i>{{ room.name }}
                        </h4>
                        <small class="text-white-50">
                            <i class="fas fa-user me-1" aria-hidden="true"></i>Criada por: {{ room.creator }}
                        </small>
                    </div>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-hashtag" aria-hidden="true"></i> {{ room.id }}
                        </span>
                        <button id="sairSala" 
                                class="btn btn-outline-light"
                                title="Sair da sala de chat"
                                aria-label="Sair da sala {{ room.name }}">
                            <i class="fas fa-sign-out-alt me-1" aria-hidden="true"></i>SAIR
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Messages Area -->
                <div class="chat-messages" 
                     id="mensagensChat" 
                     role="log" 
                     aria-live="polite" 
                     aria-label="Mensagens do chat">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-comments fa-3x mb-3 opacity-50" aria-hidden="true"></i>
                        <p class="fw-bold">INÍCIO DA CONVERSA</p>
                        <p>As mensagens aparecerão aqui conforme forem enviadas</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-container">
                    <div class="input-group">
                        <input type="text" 
                               id="entradaMensagem" 
                               class="form-control" 
                               placeholder="Digite sua mensagem..." 
                               maxlength="500"
                               aria-label="Digite sua mensagem de chat"
                               aria-describedby="botaoEnviar contadorCaracteres">
                        <button id="botaoEnviar" 
                                class="btn btn-primary" 
                                type="button" 
                                title="Enviar mensagem"
                                aria-label="Enviar mensagem no chat">
                            <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted fw-bold">
                            <i class="fas fa-user me-1" aria-hidden="true"></i>CONECTADO COMO: <strong id="nomeUsuarioAtual"></strong>
                        </small>
                        <small class="text-muted fw-bold" aria-live="polite">
                            <span id="contadorCaracteres">0</span>/500 CARACTERES
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
const parametrosUrl = new URLSearchParams(window.location.search);
const nomeUsuario = parametrosUrl.get('username') || localStorage.getItem('nomeUsuarioChat');
const idSala = '{{ room.id }}';
let socket;

// Verificar se o usuário tem um nome
if (!nomeUsuario) {
    const novoNomeUsuario = prompt('Digite seu nome para entrar no chat:');
    if (!novoNomeUsuario) {
        window.location.href = '/';
    } else {
        localStorage.setItem('nomeUsuarioChat', novoNomeUsuario);
        window.location.search = `username=${encodeURIComponent(novoNomeUsuario)}`;
    }
} else {
    document.getElementById('nomeUsuarioAtual').textContent = nomeUsuario;
    inicializarChat();
}

function inicializarChat() {
    socket = io();
    
    // Eventos do Socket
    socket.on('connect', function() {
        console.log('Conectado ao servidor');
        socket.emit('entrar', {
            id_sala: idSala,
            nome_usuario: nomeUsuario
        });
        adicionarMensagemSistema(`Você entrou na sala como ${nomeUsuario}`);
    });
    
    socket.on('disconnect', function() {
        adicionarMensagemSistema('Conexão perdida. Tentando reconectar...');
    });
    
    socket.on('usuario_entrou', function(dados) {
        if (dados.nome_usuario !== nomeUsuario) {
            adicionarMensagemSistema(`${dados.nome_usuario} entrou na sala`);
        }
    });
    
    socket.on('usuario_saiu', function(dados) {
        adicionarMensagemSistema(`${dados.nome_usuario} saiu da sala`);
    });
    
    socket.on('mensagem_chat', function(dados) {
        adicionarMensagem(dados);
    });
    
    // Eventos da interface
    document.getElementById('botaoEnviar').addEventListener('click', enviarMensagem);
    document.getElementById('entradaMensagem').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            enviarMensagem();
        }
    });
    
    document.getElementById('entradaMensagem').addEventListener('input', function() {
        const contadorCaracteres = this.value.length;
        document.getElementById('contadorCaracteres').textContent = contadorCaracteres;
        
        if (contadorCaracteres > 450) {
            document.getElementById('contadorCaracteres').style.color = '#e74c3c';
        } else {
            document.getElementById('contadorCaracteres').style.color = '#6c757d';
        }
    });
    
    document.getElementById('sairSala').addEventListener('click', function() {
        if (confirm('Tem certeza que deseja sair da sala?')) {
            socket.emit('sair', {
                id_sala: idSala,
                nome_usuario: nomeUsuario
            });
            localStorage.removeItem('nomeUsuarioChat');
            window.location.href = '/';
        }
    });
}

function enviarMensagem() {
    const entrada = document.getElementById('entradaMensagem');
    const mensagem = entrada.value.trim();
    
    if (mensagem && socket) {
        socket.emit('mensagem_chat', {
            id_sala: idSala,
            nome_usuario: nomeUsuario,
            mensagem: mensagem
        });
        entrada.value = '';
        document.getElementById('contadorCaracteres').textContent = '0';
        document.getElementById('contadorCaracteres').style.color = '#6c757d';
    }
}

function adicionarMensagem(dados) {
    const containerMensagens = document.getElementById('mensagensChat');
    const divMensagem = document.createElement('div');
    const ehPropria = dados.nome_usuario === nomeUsuario;
    
    divMensagem.className = `message ${ehPropria ? 'message-own' : 'message-other'}`;
    
    const horarioMensagem = new Date().toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    divMensagem.innerHTML = `
        <div class="message-header">
            ${!ehPropria ? `<strong>${dados.nome_usuario}</strong> • ` : ''}${dados.horario || horarioMensagem}
        </div>
        <div class="message-bubble">
            ${escaparHtml(dados.mensagem)}
        </div>
    `;
    
    containerMensagens.appendChild(divMensagem);
    containerMensagens.scrollTop = containerMensagens.scrollHeight;
}

function adicionarMensagemSistema(texto) {
    const containerMensagens = document.getElementById('mensagensChat');
    const divMensagem = document.createElement('div');
    
    divMensagem.className = 'message message-system';
    divMensagem.innerHTML = `
        <div class="message-bubble">
            <i class="fas fa-info-circle me-1"></i>${escaparHtml(texto)}
        </div>
    `;
    
    containerMensagens.appendChild(divMensagem);
    containerMensagens.scrollTop = containerMensagens.scrollHeight;
}

function escaparHtml(texto) {
    const div = document.createElement('div');
    div.textContent = texto;
    return div.innerHTML;
}

// Foco automático na entrada de mensagem
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const entrada = document.getElementById('entradaMensagem');
        if (entrada) entrada.focus();
    }, 500);
});
</script>
{% endblock %}